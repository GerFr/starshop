<!doctype html>
<html lang="en">

<head>
  <title>Starshop</title>
  <!-- Required meta tags -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

  <!-- bootstrap -->
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <!-- source: https://cdn.jsdelivr.net/npm/bootstrap-dark-5@1.1.3/dist/css/bootstrap-dark.min.css -->
  <!-- icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="icon" href="assets/icons/stars.png">
  <!-- handlebars -->
  <script src="js/handlebars.min-v4.7.8.js"></script>
  <script src="js/vanilla.js"></script>

  <script>
    function init() {
      $on($('#search'), 'click', search)
      render({}, '[type="text/x-handlebars-navbar"]')
      render({}, '[type="text/x-handlebars-footer"]')
      
      query = sessionStorage.getItem("query")
      if (!(query===null)){
        render({"query": query}, '[type="text/x-handlebars-query"]')
      }

      const form = document.querySelector('.needs-validation')
      form.addEventListener('submit', event => {
        if (!form.checkValidity()) {
          event.preventDefault()
          event.stopPropagation()
        }
        form.classList.add('was-validated')
      }, false)
      function handleForm(event) { event.preventDefault(); }
      form.addEventListener('submit', handleForm);

      const queryData = sessionStorage.getItem("queryData")
      const baseData = localStorage.getItem("data")

      if (!(queryData === null)) {
        const data = JSON.parse(queryData)
        render(data.slice(0, 20), '[type="text/x-handlebars-template"]')
      }
      else if (!(baseData === null)) {
        const data = JSON.parse(baseData)
        render(data.slice(0, 20), '[type="text/x-handlebars-template"]')
      }
      else {
        fetch('data/hygfull.json')
          .then(response => response.json())
          .then(data => {
            localStorage.setItem("data", JSON.stringify(data))
            location.reload()
          })
          .catch(error => console.error('Error fetching JSON file:', error));
      }
    }

    function search(event) {
      const query = document.getElementById("query").value
      if (!(query == "")) {
        console.log(query);
        data = JSON.parse(localStorage.getItem("data"))
        const queryData = searchData(query, data)
        sessionStorage.setItem("queryData", JSON.stringify(queryData))
        sessionStorage.setItem("query", query)
        location.reload();
      }
    }

    function searchData(query, data) {
      const words = []
      data.forEach(element => {
        starName = element["ProperName"]
        starID = element["StarID"]
        distance = levenshteinDistance(starName, query)
        const star = {"id":starID, "dist":distance}
        words.push(star)
      });
      const sortedIDs = words.sort((a, b) => a.dist - b.dist).map(obj => obj.id).slice(0,20)
      const queryData = getById(sortedIDs, data)
      return queryData
    }

    function getById(sortedIDs, data){
      const queryData = []
      sortedIDs.forEach(ID => {
        data.forEach(star => {
          if (star.StarID === ID){
            queryData.push(star)
          }
        });
      });
      return queryData
    }

    function levenshteinDistance(first, second) {
      first = first.toLowerCase()
      second = second.toLowerCase()

      const matrix = [];

      for (let i = 0; i <= second.length; i++) {
        matrix[i] = [i];
      }

      for (let j = 0; j <= first.length; j++) {
        matrix[0][j] = j;
      }

      for (let i = 1; i <= second.length; i++) {
        for (let j = 1; j <= first.length; j++) {
          if (second.charAt(i - 1) === first.charAt(j - 1)) {
            matrix[i][j] = matrix[i - 1][j - 1];
          } else {
            matrix[i][j] = Math.min(
              matrix[i - 1][j - 1] + 1,
              matrix[i][j - 1] + 1,
              matrix[i - 1][j] + 1
            );
          }
        }
      }
      return matrix[second.length][first.length];
    }
  </script>

</head>

<body onload="init()">

  <script id="template" type="text/x-handlebars-navbar">
    {{> navbar }}
  </script>
  <div></div>

  <!-- MARK:image and intro
    -->
  <section id="intro">
    <div class="container-lg my-5">
      <div class="row justify-contents-center align-items-center">
        <div class="col-md-5 text-center text-md-start">
          <h1>
            <div class="display-2">Buy a Star</div>
            <div class="display-5 text-muted">Leave a Lasting Legacy</div>
          </h1>
          <p class="lead my-4 text-muted">Choose Any Star Visible in the Sky from the Famous <a
              href="https://github.com/astronexus/HYG-Database/blob/main/hyg/v2/hygfull.csv"><strong>HYG</strong></a>
            Database - A Truly
            Unique Gift for
            the Rich and Successful</p>
          <a href="#pricing" class="btn btn-secondary btn-lg">Buy Now</a>
        </div>
        <div class="col-md-5 text-center d-none d-md-block">
          <img src="assets/StarField.jpg" alt="star image" class="img-fluid rounded">
        </div>
      </div>

    </div>
  </section>

  <!-- MARK: Articles 
  -->
  <section id="pricing" class="bg-black mt-5">

    <div class="container-l py-4">
      <div class="text-center">
        <h2>Star Collection</h2>
        <p class="lead text-muted">choose the perfect star</p>
      </div>

      <nav class="navbar bg-body-tertiary sticky-top bg-black">
        <div class="container-fluid">
          <a class="navbar-brand"></a>
          <form class="d-flex needs-validation" novalidate>
            <script id="template" type="text/x-handlebars-query">
              {{query}}
            </script>
            <div class="text-light px-4"></div>
            <input id="query" class="form-control me-2" type="text" placeholder="Search" aria-label="Search" required>
            <button class="btn btn-outline-white btn-secondary" type="submit" id="search">Search</button>
            <a class="btn mx-2 btn-primary" href="warenkorb.html">Cart</a>
          </form>
        </div>
      </nav>

      <script id="template" type="text/x-handlebars-template">
        {{> card }}
      </script>
      <div class="row mx-sm-5 align-items-center justify-content-center g-2"></div>
    </div>
  </section>


  <!-- MARK: modal
   -->
  <script id="template" type="text/x-handlebars-template">
   {{> modal }}
  </script>
  <div></div>

  <script>
    CART = "cart"
    function tocart(sID) {
      setTimeout(function() {
        document.getElementById('cartAlert'+sID).classList.remove('d-none');
   
        setTimeout(function() {
          document.getElementById('cartAlert'+sID).classList.add('d-none');
        }, 500);
      }, 20);

      var cartarr = sessionStorage.getItem(CART)
      if (cartarr === null) {
        cartarr = [sID]
      }
      else if (JSON.parse(cartarr).includes(sID) === false) {
        cartarr = JSON.parse(cartarr)
        cartarr.push(sID);
      }
      sessionStorage.setItem(CART, JSON.stringify(cartarr))
    }
  </script>


  <script id="template" type="text/x-handlebars-footer">
    {{> footer }}
  </script>
  <div></div>

  <!-- Bootstrap JavaScript Libraries -->
  <script src="js/bootstrap.js"></script>

</body>

</html>